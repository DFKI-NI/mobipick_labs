<?xml version="1.0"?>
<launch>

  <!-- the pose where to spawn the robot in simulation -->
  <arg name="robot_x"   default="10.50" />
  <arg name="robot_y"   default="2.30" />
  <arg name="robot_yaw" default="3.1415" />

  <!-- smart factory gazebo simulation -->
  <include file="$(find mobipick_gazebo)/launch/mobipick/tables_demo.launch" >
    <arg name="robot_x"   value="$(arg robot_x)" />
    <arg name="robot_y"   value="$(arg robot_y)" />
    <arg name="robot_yaw" value="$(arg robot_yaw)" />
  </include>

  <!-- automatically unpause gazebo simulation after some time -->
  <node pkg="pbr_gazebo" type="gazebo_unpauser" name="gazebo_unpauser" output="screen" />

  <!-- object publisher for pick_n_place demo -->
  <node name="gazebo_object_publisher" pkg="mobipick_pick_n_place" type="gazebo_object_publisher" ns="mobipick" output="screen">
    <param name="tf_prefix"  value="mobipick" />
    <param name="robot_name" value="mobipick" />
  </node>

  <!-- node to publish the camera frustum as visualisation marker -->
  <node pkg="mobipick_pick_n_place" type="camera_marker_publisher" name="camera_marker_publisher" output="screen" >
    <param name="camera_frame" value="mobipick/gripper_astra_depth_frame" />
  </node>

  <!-- fake localisation (for simulation only) -->
  <include file="$(find mir_gazebo)/launch/fake_localization.launch" ns="mobipick">
    <arg name="odom_frame_id" value="mobipick/odom" />
    <arg name="base_frame_id" value="mobipick/base_footprint" />
  </include>

  <!-- navigation stack -->
  <include file="$(find mir_navigation)/launch/start_planner.launch">
    <arg name="map_file" value="$(find pbr_maps)/maps/tables_demo/tables_demo.yaml" />
    <arg name="virtual_walls_map_file" value="$(find pbr_maps)/maps/tables_demo/tables_demo_virtual_walls.yaml" />
    <arg name="prefix" value="mobipick/" />
  </include>

  <!-- MoveIt: arm movement -->
  <include file="$(find mobipick_moveit_config)/launch/moveit_planning_execution.launch">
    <arg name="use_pointcloud" value="true"/>
    <arg name="simulation" value="true"/>
  </include>

  <!-- task server -->
  <include file="$(find mobipick_task_server)/launch/mobipick_task_server.launch" />

  <!-- MoveIt macros -->
  <include file="$(find robot_api)/launch/moveit_macros.launch">
    <arg name="namespace" value="mobipick" />
  </include>

  <!-- force torque observer -->
  <node name="ft_observer" pkg="mobipick_pick_n_place" type="ft_observer_sim.py" ns="mobipick" output="screen" />

  <!-- pose selector: DB to store object poses -->
  <arg name="objects_of_interest" value="[relay, screwdriver, multimeter, powerdrill_with_grip, klt]"/>
  <node pkg="pose_selector" type="pose_selector_node" name="pose_selector_node" output="screen">
    <param name="debug" value="false" />
    <param name="global_reference_frame" value="map" />
    <rosparam param="objects_of_interest" subst_value="True">$(arg objects_of_interest)</rosparam>
  </node>

  <!-- grasp planning -->
  <!-- visualise gripper in rviz as marker -->
  <node pkg="grasplan" type="rviz_gripper_visualiser.py" name="rviz_gripper_visualiser" output="screen">
    <param name="global_reference_frame" type="string" value="map" />
    <rosparam file="$(find mobipick_pick_n_place)/config/grasplan/gripper_open_transformations.yaml" command="load" ns="gripper_transformations"/>
    <remap from="pose_array" to="/mobipick/pick_object_node/grasp_poses"/>
  </node>
  <!-- pick object script using hardcoded grasp planner -->
  <node pkg="grasplan" type="pick.py" name="pick_object_node" output="screen" ns="mobipick" >
    <param name="import_file" type="string" value="grasplan.grasp_planner.handcoded_grasp_planner" />
    <param name="import_class" type="string" value="HandcodedGraspPlanner" />
    <rosparam file="$(find mobipick_pick_n_place)/config/grasplan/pick_params.yaml" command="load" />
    <rosparam file="$(find tables_demo_bringup)/config/tables_planning_scene.yaml" command="load" />
    <rosparam file="$(find mobipick_pick_n_place)/config/grasplan/grasp_planning_core_params.yaml" command="load" />
    <!-- allows to specify how much the gripper should close per object -->
    <rosparam file="$(find mobipick_pick_n_place)/config/grasplan/object_grasps/gripper_joint_values_per_object.yaml" command="load" />
    <!-- pregrasp planner parameters -->
    <rosparam file="$(find mobipick_pick_n_place)/config/grasplan/object_grasps/handcoded_grasp_planner_relay.yaml"
              command="load" ns="handcoded_grasp_planner_transforms" />
    <rosparam file="$(find mobipick_pick_n_place)/config/grasplan/object_grasps/handcoded_grasp_planner_screwdriver.yaml"
              command="load" ns="handcoded_grasp_planner_transforms" />
    <rosparam file="$(find mobipick_pick_n_place)/config/grasplan/object_grasps/handcoded_grasp_planner_multimeter.yaml"
              command="load" ns="handcoded_grasp_planner_transforms" />
    <rosparam file="$(find mobipick_pick_n_place)/config/grasplan/object_grasps/handcoded_grasp_planner_klt.yaml"
              command="load" ns="handcoded_grasp_planner_transforms" />
    <rosparam file="$(find mobipick_pick_n_place)/config/grasplan/object_grasps/handcoded_grasp_planner_powerdrill_with_grip.yaml"
              command="load" ns="handcoded_grasp_planner_transforms" />
  </node>

</launch>
